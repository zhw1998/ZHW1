function Chat(data){this._init(data)}Chat.prototype={config:{user:{},url:"http://zouhongwei.com:8800/WAChat",wsurl:"ws://zouhongwei.com:8800/WAChat",sourcepath:"",islogin:false,code:100,isfill:true,logoevent:true,ws:null,},_init:function(data){this.config.sourcepath=data.sourcepath;this.inituser(data.url);this.initevent1()},inituser:function(url){var _this=this;$.ajax({url:url,type:"get",success:function(res){_this.config.user=res;res=(typeof res)=="string"?JSON.parse(res):res;var istrue=true;istrue=(res.websign==""||res.username==""||res.uUID==""||res.uUID.length!=36||res.usercode=="")?false:true;if(istrue){_this.getuser(res)}else{_this.config.code=203}}})},initevent1:function(){var _this=this;$("#chatlogo").mouseup(function(e){if(_this.config.islogin){if(chat.config.logoevent){$(this).fadeOut();_this.fillcontainer();_this.config.isfill=false;$("#chatbox").slideDown();$("#chat_container").slideDown()}}else{_this.getuser(_this.config.user)}});_this.addMove("#chatlogo","#chatlogo");$(".chat_add_friend").click(function(e){if(!_this.config.islogin){alert("添加失败，您还未登录！");return}var uid=$(this).attr("user_id");if(uid==""||uid==null){alert("添加失败");return}_this.addFriend(uid,null,e);alert("已发送请求")})},initevent2:function(){var _this=this;$("#chat_container .chat_close span").click(function(){$("#chatbox").slideUp();$("#chatlogo").fadeIn()});$("#chat_container .chat_headimg img").click(function(e){e.preventDefault();$("#chat_container .chat_headimg .chat_user_headimg").click()});$("#chat_container .chat_headimg .chat_user_headimg").change(function(){if($(this).val()==""){return}var file=$(this).get(0).files[0];chat.uploadheadimg(file,"user")});$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg_but").click(function(){$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg").click()});$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg").change(function(){if($(this).val()==""){return}var file=$(this).get(0).files[0];chat.uploadheadimg(file,"group")});$(".chat_center .chat_addchatgroup .chat_addchatgroup_submit").click(function(){chat.creatchatgroup()});$("#chat_container .chat_mes .chat_description").change(function(e){chat.updatedescription($(this).val())});$("#chat_container .chat_center ul li").click(function(){$(this).addClass("chat_on").siblings().removeClass("chat_on");$("#chat_container .chat_center_box").hide().eq($(this).index()).show();var index=$(this).index();if(index==0){_this.setrequestmes()}else{if(index==1){_this.setfriendgroup()}else{if(index==2){$("#chat_container .chat_center_box").eq(2).empty();_this.setchatgroup()}}}$(".chat_center .chat_addchatgroup").slideUp()});$("#chat_container .chat_add span").click(function(){var chat_searchbox=chatpanle.chat_searchbox;if($("#chat_container").find("#chat_search_box").length==0){$("#chat_container").append($(chat_searchbox));_this.addeventonsearchbox()}$("#chat_search_box").fadeIn()});$("#chat_container .chat_deletebox").on("dragover",function(e){$(e.currentTarget).css({color:"red"});e.originalEvent.preventDefault()}).on("dragleave",function(e){$(e.currentTarget).css({color:"white"})});$("#chat_container .chat_deletebox").on("drop",function(e){$("#chat_container .chat_deletebox").css({color:"white"});var data=JSON.parse(e.originalEvent.dataTransfer.getData("data"));if(data.type=="user"){if(confirm("忍心要抛弃他/她吗？")){chat.deletefriend(data.userid)}}else{if(data.type=="group"){if(confirm("一定要离开（群体）吗？")){chat.deletechatgroup(data.chatgroupid)}}}})},updatedescription:function(description){var url=chat.config.url+"/user/updatedescription.action";var data={uuid:chat.config.user.uUID,description:description};$.post(url,data,function(res){if(res.code==200){$("#chat_container .chat_mes .chat_description").attr("title",description)}else{$("#chat_container .chat_mes .chat_description").val($("#chat_container .chat_mes .chat_description").attr("title"))}})},deletefriend:function(userid){var url=chat.config.url+"/friend/deletefriend.action";var data={uuid1:userid,uuid2:chat.config.user.uUID};$.post(url,data,function(res){if(res.code==200){alert("再见！好之为之。。。。");$('#chat_container .chat_mesg_item[data_id="'+userid+'"]').remove()}else{alert("对不起！就粘着你了。。。。")}})},deletechatgroup:function(groupid){var url=chat.config.url+"/chatgroup/deletechatgroup.action";var data={chatgroupid:groupid,uuid:chat.config.user.uUID};$.post(url,data,function(res){if(res.code==200){alert("再见！各回各家各找各妈了。。。");$('#chat_container .chat_mesg_item[data_id="'+groupid+'"]').remove()}else{alert("大家不想让你走，留下吧！")}})},addeventonsearchbox:function(){var _this=this;_this.addMove("#chat_search_box","#chat_search_box .chat_head");$("#chat_search_box .iconfont").click(function(){$("#chat_search_box").slideUp()});$("#chat_search_input_but").click(function(){_this.searchUG()})},openchatevent:function(){var _this=this;$(".chat_mesg_item").click(function(){if($(this).attr("data_id")==null||$(this).attr("data_id")==""){return}var item=$(this).clone();if(item.find(".chat_mesg_num").length!=0){$(this).remove();
item.find(".chat_mesg_num").remove();item.find(".chat_name font").remove()}_this.oppenchat(item)})},oppenchat:function(item){var _this=this;var $chat=$("#chatbox");var state=item.attr("state");if($chat.find("#chat_message_panel").length==0){$chat.append(chatpanle.chat_box);$("#chat_message_panel .chat_message_panel_head .iconfont").click(function(){$("#chat_message_panel .chat_message_panel_body .chat_mesg_item.chat_active").click();$(this).parents("#chat_message_panel").slideUp()});$("#chat_message_panel .chat_message_panel_body").append(chatpanle.chat_box_left);$("#chat_message_panel .chat_message_panel_body").append(chatpanle.chat_box_center);this.sendandclearevent();$("#chat_message_panel .chat_message_panel_body").append(chatpanle.chat_box_right);$("#chat_message_panel .chat_chatgroup_member").append("<p>群成员</p>");$("#chat_message_panel .chat_message_panel_body .chat_chatgroup_member").append("<div class='chat_deletebox'>踢&nbsp;出&nbsp;群</div>");this.addMove("#chat_message_panel",".chat_message_panel_head");$("#chat_message_panel .chat_deletebox").on("dragover",function(e){$(e.currentTarget).css({color:"red"});e.originalEvent.preventDefault()}).on("dragleave",function(e){$(e.currentTarget).css({color:"white"})});$("#chat_message_panel .chat_deletebox").on("drop",function(e){var userid=e.originalEvent.dataTransfer.getData("userid");var uuid=chat.config.user.uUID;if(uuid==userid){return}if(confirm("踢了他？")){var data={userid:userid,chatgroupid:$("#chat_message_panel .chat_users .chat_active").attr("data_id"),uuid:uuid};var url=_this.config.url+"/groupmember/removeMember.action";$.post(url,data,function(res){if(res.code==200){$('#chat_message_panel .chat_chatgroup_member .chat_mesg_item[data_id="'+userid+'"]').fadeOut()}else{alert("处理失败！！！")}})}})}item.unbind("click");$("#chat_message_panel .chat_users").find("[data_id="+item.attr("data_id")+"]").remove();item.find(".chat_content").addClass("chat_content2");item.click(function(){$(".chat_message ul").empty();_this.getMessage($(this),-1,"next")});$("#chat_message_panel .chat_users").append(item);$(".chat_message ul").empty();this.getMessage(item,-1,"next");$("#chat_message_panel").fadeIn()},sendandclearevent:function(){var _this=this;$("#chat_message_panel .chat_message_panel_body .chat_sendmesg_but").click(function(){_this.sendMessage()});$("#chat_message_panel .chat_message_panel_body .chat_clearmesg_but").click(function(){$("#chat_message_panel .chat_message_panel_body .chat_message_textarea").val("")})},getMessage:function(item,offsetid,type){var _this=this;var state=item.attr("state");item.addClass("chat_active").siblings().removeClass("chat_active");var url;var data;var id=item.attr("data_id");if($(".chat_message_panel_body .chat_message ul").find(".chat_message_history").length==0){$(".chat_message_panel_body .chat_message ul").prepend('<li><a href="javascript:void(0)" class="chat_message_history">更多</a></li>');$(".chat_message ul li .chat_message_history").click(function(){_this.getmorehistory()})}var username=item.find(".chat_name").text();$("#chat_message_panel .chat_message_panel_head .chat_curuser").text(username);if(state==1){$("#chat_message_panel .chat_chatgroup_member").hide();$("#chat_message_panel").css({width:"680px"});url=this.config.url+"/message/listUserMessage.action";data={uuid1:id,uuid2:this.config.user.uUID,id:offsetid,type:type}}else{$("#chat_message_panel .chat_chatgroup_member").show();$("#chat_message_panel").css({width:"780px"});this.getchatgroupmember(item.attr("data_id"));url=this.config.url+"/message/listGroupMessage.action";data={groupid:id,id:offsetid,type:type,uuid:this.config.user.uUID}}$.post(url,data,function(res){if(res.code==200){var rs=res.result;_this.setmessageitem(rs,item,type)}})},setmessageitem:function(rs,item,type){var _this=this;var message=chatpanle.message;var str="";var curid=_this.config.user.uUID;var curname=_this.config.user.username;var state=item.attr("state");var username=item.find(".chat_name").text();if(state==1){for(var i=0,len=rs.length;i<len;i++){var a=$(message);var mesg=rs[i];a.attr("mesgid",mesg.id);if(mesg.sendid==curid){a.find(".chat_message_item").addClass("chat_bymyself");a.find(".chat_name").text(curname)}else{a.find(".chat_name").text(username)}a.find("span").eq(1).text(mesg.time.substr(5,11));a.find(".chat_message_item_message").text(mesg.content);if(type=="next"){$(".chat_message_panel_body .chat_message ul").append(a)}else{$(".chat_message_panel_body .chat_message ul li").eq(1).before(a)}}}else{for(var i=0,len=rs.length;i<len;i++){var a=$(message);var mesg=rs[i];a.attr("mesgid",mesg.id);if(mesg.userid==curid){a.find(".chat_message_item").addClass("chat_bymyself")}var name=mesg.username;if(!mesg.username){name=$(".chat_message_panel_body .chat_chatgroup_member .chat_mesg_item[data_id="+mesg.userid+"]").find(".chat_name").text()}a.find(".chat_name").text(name);a.find("span").eq(1).text(mesg.time.substr(5,11));a.find(".chat_message_item_message").text(mesg.content);if(type=="next"){$(".chat_message_panel_body .chat_message ul").append(a)
}else{$(".chat_message_panel_body .chat_message ul li").eq(1).before(a)}}}if(type=="next"){_this.scrollbottom()}},getmorehistory:function(){var oldid=$(".chat_message ul li").eq(1).attr("mesgid");if(!oldid){oldid=-1}var item=$("#chat_message_panel .chat_users").find(".chat_active");this.getMessage(item,oldid,"prev")},scrollbottom:function(){var $div=$("#chat_message_panel .chat_message_box .chat_message");$div[0].scrollTop=$div[0].scrollHeight},sendMessage:function(){var _this=this;var message=$("#chat_message_panel .chat_message_panel_body .chat_message_textarea").val();$("#chat_message_panel .chat_message_panel_body .chat_message_textarea").val("");var item=$("#chat_message_panel .chat_users").find(".chat_active");var receiveid=item.attr("data_id");var sendid=this.config.user.uUID;var data={receiveid:receiveid,sendid:sendid,content:message,type:item.attr("state")};ws=_this.config.ws;if(ws==null){_this.openws()}ws.send(JSON.stringify(data))},dealMessage:function(data){var mesg=$.parseJSON(data.data).result;var item="";if(mesg.receiveid){item=$('#chat_message_panel .chat_users .chat_mesg_item[data_id="'+mesg.receiveid+'"]');item=(item.length==0)?$('#chat_message_panel .chat_users .chat_mesg_item[data_id="'+mesg.sendid+'"]'):item}else{item=$('#chat_message_panel .chat_users .chat_mesg_item[data_id="'+mesg.groupid+'"]')}var audio=new Audio(chat.config.sourcepath+"chat/img/dingdong.mp3");if(item.length==0){audio.play();$(".chat_center .chat_nav li:eq(0)").click();$("#chat_logo").hover()}else{if(item.hasClass("chat_active")){var rs=new Array();rs.push(mesg);console.log(rs);this.setmessageitem(rs,item,"next")}else{audio.play()}}},openws:function(){if("WebSocket" in window){var url=this.config.wsurl+"/websocket";this.config.ws=new WebSocket(url)}else{if("MozWebSocket" in window){this.config.ws=new MozWebSocket(url)}else{alert("对不起您的浏览器不支持WebSocket聊天！！");return}}this.config.ws.onopen=function(){};this.config.ws.onmessage=function(evt){chat.dealMessage(evt)};this.config.ws.onclose=function(){alert("您已掉线！！");$("#chat_message_panel").remove();$("#chatbox").slideUp();$("#chat_container").slideUp();$("#chatlogo").fadeIn();chat.config.islogin=false}},getchatgroupmember:function(groupid){$("#chat_message_panel .chat_chatgroup_member .chat_mesg_item").remove();var url=this.config.url+"/groupmember/listmember.action";var data={groupid:groupid};$.get(url,data,function(res){if(res.code==200){var chat_center_box_item=chatpanle.chat_center_box_item;for(var i=0,len=res.result.length;i<len;i++){var item=res.result[i];var a=$(chat_center_box_item);a.find("img").attr("src",chat.config.sourcepath+"chat/img/default.png");if(item.headimgpath){a.find("img").attr("src",item.headimgpath)}a.attr("data_id",item.uUID);a.find(".chat_name").text(item.username);a.find(".chat_mesg").attr("title",item.description).text(item.description);if(item.state==0){a.addClass("chat_out")}a.find(".chat_content").addClass("chat_content2");if(item.status==2){a.find(".chat_name").css({color:"red"});$("#chat_message_panel .chat_chatgroup_member>p").after(a)}else{$("#chat_message_panel .chat_chatgroup_member").append(a)}}var ownerid=$("#chat_message_panel .chat_users .chat_active").attr("owner_id");var uuid=chat.config.user.uUID;if(ownerid==uuid){$("#chat_message_panel .chat_chatgroup_member .chat_mesg_item").attr("draggable","true");$("#chat_message_panel .chat_chatgroup_member .chat_mesg_item").on("dragstart",function(e){var userid=$(this).attr("data_id");e.originalEvent.dataTransfer.setData("userid",userid);$("#chat_message_panel .chat_chatgroup_member .chat_deletebox").fadeIn()});$("#chat_message_panel .chat_chatgroup_member .chat_mesg_item").on("dragend",function(){$("#chat_message_panel .chat_chatgroup_member .chat_deletebox").fadeOut()})}}})},addChatGroup:function(groupid,butdiv){var _this=this;$.ajax({url:_this.config.url+"/groupmember/addchatgroup.action",type:"post",data:{userid:_this.config.user.uUID,groupid:groupid},success:function(res){if(res.code==200){result=res.result;butdiv.text("已发送请求")}else{butdiv.text("已加入")}}})},setfriendGroup:function(touser_id,butdiv,e,callback){var groups=this.getfriendgroup();$box=$(chatpanle.choosefriendgroup);option="";for(var i=0,len=groups.length;i<len;i++){var a=groups[i];option+='<option value ="'+a.id+'">'+a.name+"</option>"}$box.find(".chat_choosefriendgroup_select").append(option);var top=(e.clientY-30)<15?15:e.clientY-30;var left=(e.clientX-150)<15?15:e.clientX-150;$box.css({top:top+"px",left:left+"px"});$("#chatbox").append($box);$box.show();$("#chatbox .chat_choosefriendgroup .chat_choosefriendgroup_sure").click(function(){callback(touser_id,butdiv);$("#chatbox .chat_choosefriendgroup").remove()});$("#chatbox .chat_choosefriendgroup .chat_choosefriendgroup_close").click(function(){$("#chatbox .chat_choosefriendgroup").remove()})},addFriend2:function(touser_id,butdiv){var ask_userid=chat.config.user.uUID;groupid=$("#chatbox .chat_choosefriendgroup .chat_choosefriendgroup_select").val();$.ajax({url:chat.config.url+"/friend/addfriend.action",type:"post",data:{ask_userid:ask_userid,to_userid:touser_id,groupid:groupid},success:function(res){if(res.code==200){result=res.result;
butdiv.text("已发送请求")}else{butdiv.text("已是好友")}}})},addFriend:function(touser_id,butdiv,e){var _this=this;var ask_userid=_this.config.user.uUID;if(ask_userid==touser_id){if(butdiv){butdiv.text("加自己干嘛")}return}var groupid=_this.setfriendGroup(touser_id,butdiv,e,_this.addFriend2)},getuser:function(date){var _this=this;var url=_this.config.url;$.ajax({url:url+"/user/insert.action",data:date,type:"post",xhrFields:{withCredentials:true},crossDomain:true,success:function(res){if(res.code==200){_this.config.islogin=true;_this.config.user=res.result;$("#chatlogo .iconfont").css({color:"green",fontWeight:"bold"});ws=_this.config.ws;_this.openws()}else{_this.config.user=null;alert("您还未登陆或者登陆失败!")}_this.config.code=res.code}})},fillcontainer:function(){if(this.config.isfill){var chat_all_box=chatpanle.chat_all_box;$("html body").append(chat_all_box);var chathead=chatpanle.chat_head;$("#chat_container").prepend(chathead);this.addMove("#chatbox",".chat_chathead");var user=this.config.user;$("#chat_container .chat_mes .chat_username").text(user.username);var src=(user.headimgpath==""||!user.headimgpath)?chat.config.sourcepath+"chat/img/default.png":user.headimgpath;$("#chat_container .chat_headimg img").attr("src",src);$("#chat_container .chat_mes .chat_description").attr("title",user.description);$("#chat_container .chat_mes .chat_description").val(user.description);var chat_center=chatpanle.chat_center;$("#chat_container").append(chat_center);var chat_center_nav=chatpanle.chat_center_nav;$("#chat_container .chat_center").append(chat_center_nav);var chat_center_box=chatpanle.chat_center_box;for(var i=0;i<3;i++){$("#chat_container .chat_center").append(chat_center_box)}$("#chat_container .chat_center_box").first().show();var creatchatgroup=chatpanle.creatchatgroup;$("#chat_container .chat_center").append(creatchatgroup);$("#chat_container .chat_center").append("<div class='chat_deletebox'>拖&nbsp;到&nbsp;这&nbsp;移&nbsp;除</div>");this.initevent2()}this.setrequestmes()},fileupload:function(filedata,callback){var url=chat.config.url+"/file/uploadheadimg.action";$.ajax({url:url,type:"post",data:filedata,processData:false,contentType:false,success:function(rs){callback(rs)}})},uploadheadimg:function(file,headimgtype){if(!file.type.startsWith("image/")){alert("请上传图片文件！");return false}if(file.size>1024*520){alert("文件不能大于512KB");return false}var formdata=new FormData();formdata.append("file",file);chat.fileupload(formdata,function(rs){var src=rs.result;if(headimgtype=="group"){$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg_but").attr("imgpath",src);$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg_but").css({background:"url("+src+") no-repeat","background-size":"100% 100%"})}else{if(headimgtype=="user"){var data={uuid:chat.config.user.uUID,headimgpath:src};var url=chat.config.url+"/user/updateheadimg.action";$.post(url,data,function(res){if(res.code==200){$("#chat_container .chat_headimg img").attr("src",src)}else{alert("头像更换失败")}})}}})},creatchatgroup:function(){var $groupname=$(".chat_center .chat_addchatgroup .chat_addchatgroup_groupname");if($groupname.val().trim()==""||$groupname.val().trim().length>=10){erro($groupname);return}var $groupdescription=$(".chat_center .chat_addchatgroup .chat_addchatgroup_description");if($groupdescription.val().trim().length>=30){erro($groupdescription);return}var url=chat.config.url+"/chatgroup/addchatgroup.action";var headimgpath=$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg_but").attr("imgpath");var data={groupname:$groupname.val().trim(),description:$groupdescription.val().trim(),headimgpath:headimgpath,ownerid:chat.config.user.uUID};$.post(url,data,function(res){if(res.code==200){$(".chat_center .chat_addchatgroup").hide();$("#chat_container .chat_center ul li").eq(2).click()}else{alert("创建失败！每人只能创建5个群哦！")}clear()});function clear(){$(".chat_center .chat_addchatgroup input").val("");$(".chat_center .chat_addchatgroup .chat_addchatgroup_headimg_but").css({background:"none"})}function erro(input){input.focus();input.css({border:"2px solid red"});setTimeout(function(){input.css({border:"1px solid black"})},2000)}},setchatgroup:function(){var _this=this;var uuid=_this.config.user.uUID;var data={uuid:uuid};var url=_this.config.url+"/chatgroup/listchatgroup.action";$.get(url,data,function(res){if(res.code==200){var chat_center_box_item=chatpanle.chat_center_box_item;for(var i=0,len=res.result.length;i<len;i++){var item=res.result[i];var a=$(chat_center_box_item);a.find("img").attr("src",chat.config.sourcepath+"chat/img/groupdefault.png");if(item.headimgpath){a.find("img").attr("src",item.headimgpath)}a.attr("data_id",item.id);a.attr("owner_id",item.ownerid);a.find(".chat_name").text(item.groupname);a.attr("state",2);a.find(".chat_mesg").attr("title",item.description).text(item.description);if(uuid==item.ownerid){a.find(".chat_name").css({color:"red"});$(".chat_center_box").eq(2).prepend(a)}else{$(".chat_center_box").eq(2).append(a)}a.attr("draggable","true")
}$("#chat_container .chat_mesg_item").on("dragstart",function(e){chatgroupid=$(this).attr("data_id");data={type:"group",chatgroupid:chatgroupid};e.originalEvent.dataTransfer.setData("data",JSON.stringify(data));$("#chat_container .chat_deletebox").show()});$("#chat_container .chat_mesg_item").on("dragend",function(e){$("#chat_container .chat_deletebox").hide()});_this.openchatevent()}});$(".chat_center_box").eq(2).append('<div class="chat_addchatgroup_showbut"><span class="iconfont">&#xe697</span>');$(".chat_center_box").eq(2).find(".chat_addchatgroup_showbut").click(function(){$(this).find(".iconfont").toggleClass("iconfont_ative");$(".chat_center .chat_addchatgroup").slideToggle()})},setrequestmes:function(){$("#chat_container .chat_center_box").first().empty();var _this=this;var r1=false;var r2=false;var url1=_this.config.url+"/friend/friendrequest.action?UUID="+_this.config.user.uUID;$.get(url1,function(res){if(res.code==200){var chat_center_box_item=chatpanle.chat_center_box_item;for(var i=0;i<res.result.length;i++){var item=res.result[i];var a=$(chat_center_box_item);var src=(item.headimgpath)?item.headimgpath:chat.config.sourcepath+"chat/img/default.png";a.find("img").attr("src",src);a.find(".chat_name").html(item.username+"  <font size='1'>"+item.ask_time.substr(5,11)+"</font>");var te="<font color='green'>"+item.username+"</font> 申请添加你为好友:!!!";a.find(".chat_mesg").html(te);a.attr("ask_userid",item.uUID);var allowbut='<button class="chat_allowbut">同意</button>';var nobut='<button class="chat_nobut">拒绝</button>';a.append(allowbut);a.append(nobut);$("#chat_container .chat_center_box").first().append(a)}}r1=true;addclick()});var url2=_this.config.url+"/groupmember/chatgrouprequest.action?ownerid="+_this.config.user.uUID;$.get(url2,function(res){if(res.code==200){var chat_center_box_item=chatpanle.chat_center_box_item;for(var i=0;i<res.result.length;i++){var item=res.result[i];var a=$(chat_center_box_item);var src=(item.headimgpath)?item.headimgpath:chat.config.sourcepath+"chat/img/groupdefault.png";a.find("img").attr("src",src);a.find(".chat_name").html(item.groupname+"  <font size='1'>"+item.ask_time.substr(5,11)+"</font>");var te="<font color='green'>"+item.username+"</font>  请求加入群！！！";a.find(".chat_mesg").html(te);a.attr("userid",item.uUID);a.attr("chatgroupid",item.id);var allowbut='<button class="chat_allowbut">同意</button>';var nobut='<button class="chat_nobut">拒绝</button>';a.append(allowbut);a.append(nobut);$("#chat_container .chat_center_box").first().append(a)}}r2=true;addclick()});var url3=_this.config.url+"/search/noReadMes.action?uuid="+_this.config.user.uUID;$.get(url3,function(res){if(res.code==200){var chat_center_box_item=chatpanle.chat_center_box_item;for(var i=0,len=res.result.length;i<len;i++){var item=res.result[i];var a=$(chat_center_box_item);var src=(item.headimg)?item.headimg:chat.config.sourcepath+"chat/img/default.png";if(item.type==2){src=(item.headimgpath)?item.headimgpath:chat.config.sourcepath+"chat/img/groupdefault.png"}a.find("img").attr("src",src);a.find(".chat_name").html(item.name+"  <font size='1'>"+item.time.substr(5,11)+"</font>");a.attr("data_id",item.uid);a.attr("state",item.type);a.find(".chat_mesg").attr("title",item.content).text(item.content);a.append('<div class="chat_mesg_num">'+item.num+"</div>");$("#chat_container .chat_center_box").first().append(a)}_this.openchatevent()}});function addclick(){if(r1&&r2){$("#chat_container .chat_mesg_item .chat_allowbut").click(function(e){_this.dorequest($(this),true,e)});$("#chat_container  .chat_mesg_item .chat_nobut").click(function(e){_this.dorequest($(this),false,e)})}}},agreefriend:function(data,nullparam){data.groupid=$("#chatbox .chat_choosefriendgroup .chat_choosefriendgroup_select").val();var url=chat.config.url+"/friend/dofriendrequest.action";$.post(url,data,function(res){if(res.code==200){$('.chat_center_box .chat_mesg_item[ask_userid="'+data.ask_userid+'"]').slideUp()}else{alert("处理失败！！！")}})},dorequest:function(that,isagree,e){var _this=this;var state=isagree?2:1;if(that.parent().attr("ask_userid")){var ask_userid=that.parent().attr("ask_userid");var data={ask_userid:ask_userid,to_userid:_this.config.user.uUID,state:state,groupid:-1};if(isagree){chat.setfriendGroup(data,null,e,chat.agreefriend)}else{sendrequest("/friend/dofriendrequest.action",data)}}else{var data={userid:that.parent().attr("userid"),chatgroupid:that.parent().attr("chatgroupid"),state:state};sendrequest("/groupmember/doCGroupRequest.action",data)}function sendrequest(url,data){var url=_this.config.url+url;$.post(url,data,function(res){if(res.code==200){that.parent().slideUp()}else{alert("处理失败！！！")}})}},getfriendgroup:function(){var _this=this;var data={UUID:_this.config.user.uUID};var result={};$.ajax({url:_this.config.url+"/friendgroup/listall.action",async:false,type:"get",data:data,xhrFields:{withCredentials:true},crossDomain:true,success:function(res){if(res.code==200){result=res.result}}});return result},addnewfriendgroup:function(groupname){var url=chat.config.url+"/friendgroup/addfriendsgroup.action";
var data={name:groupname,userid:chat.config.user.uUID};$.post(url,data,function(res){if(res.code==200){chat.setfriendgroup()}})},deletefriendgroup:function(friendgroupitem){var friendgroupid=friendgroupitem.attr("date_id");var data={groupid:friendgroupid,uuid:chat.config.user.uUID};var url=chat.config.url+"/friendgroup/deletefriendsgroup.action";$.get(url,data,function(res){if(res.code==200){friendgroupitem.remove()}else{alert("删除失败！该分组中可能存在好友！")}})},setfriendgroup:function(){var _this=this;$("#chat_container .chat_center_box").eq(1).empty();var friendgroup_item=chatpanle.friendgroup_item;var list=this.getfriendgroup();if(list.length>0){var liststr;for(var i=0;i<list.length;i++){var a=$(friendgroup_item).attr("date_id",list[i].id);a.find(".chat_groupname").text(list[i].name);$("#chat_container .chat_center_box").eq(1).append(a)}}else{$("#chat_container .chat_center_box").eq(1).html("<h3>您还没有分组！！！</h3>")}$("#chat_container .chat_center_box .chat_friendgroup_item").append('<button class="chat_deletefriendgroup">删除</button>');$("#chat_container .chat_friendgroup_item>.chat_deletefriendgroup").click(function(e){e.stopPropagation();chat.deletefriendgroup($(this).parent())});var a="<div class='chat_addgroup'><span class='iconfont'>&#xe697</span><input type='text' placeholder='请输入分组名'/></div>";$("#chat_container .chat_center_box").eq(1).append(a);$("#chat_container .chat_center_box .chat_addgroup .iconfont").click(function(){var input=$("#chat_container .chat_addgroup>input");if(input.css("display")!="none"){var groupname=input.val().trim();if(groupname!=""){chat.addnewfriendgroup(groupname)}input.val("");$("#chat_container .chat_addgroup>input").fadeOut()}else{$("#chat_container .chat_addgroup>input").fadeIn()}});$("#chat_container .chat_friendgroup_item").click(function(){$(this).find(".iconfont").toggleClass("chat_itemon");$(this).siblings().find(".iconfont").removeClass("chat_itemon");$("#chat_container .chat_center_box").find(".chat_friends").detach();var friends=chatpanle.friends;$(this).has(".chat_itemon").after(friends);$("#chat_container .chat_center_box .chat_friends").slideDown();if($(this).has(".chat_itemon").length>0){var grouid=$(this).attr("date_id");_this.getfriends(grouid,_this.config.user.uUID)}});$("#chat_container .chat_friendgroup_item").on("dragover",function(e){$(e.currentTarget).addClass("chat_active");e.originalEvent.preventDefault()}).on("dragleave",function(e){$(e.currentTarget).removeClass("chat_active")});$("#chat_container .chat_friendgroup_item").on("drop",function(e){var data=JSON.parse(e.originalEvent.dataTransfer.getData("data"));var curgroupid=$(this).attr("date_id");if(curgroupid!=data.befgroupid){_this.updatafriendgroup(data.userid,curgroupid)}})},updatafriendgroup:function(touserid,groupid){var ask_userid=chat.config.user.uUID;var url=chat.config.url+"/friend/updatefriendgroup.action";var data={uuid:chat.config.user.uUID,userid:touserid,groupid:groupid};$.post(url,data,function(res){if(res.code==200){$('#chat_container .chat_friendgroup_item[date_id="'+groupid+'"]').removeClass("chat_active").click()}})},getfriends:function(groupid,UUID){var _this=this;$.ajax({url:_this.config.url+"/friend/listall.action",data:{groupid:groupid,UUID:UUID},type:"post",success:function(res){if(res.code==200){var chat_center_box_item=chatpanle.chat_center_box_item;for(var i=0,len=res.result.length;i<len;i++){var item=res.result[i];var a=$(chat_center_box_item);a.find("img").attr("src",chat.config.sourcepath+"chat/img/default.png");if(item.headimgpath){a.find("img").attr("src",item.headimgpath)}a.attr("data_id",item.uUID);a.attr("state",1);a.find(".chat_name").text(item.username);a.find(".chat_mesg").attr("title",item.description).text(item.description);if(item.state==0){a.addClass("chat_out")}a.attr("draggable","true");$(".chat_friends").append(a)}$("#chat_container .chat_mesg_item").on("dragstart",function(e){var userid=$(this).attr("data_id");var befgroupid=$(this).parent().prev().attr("date_id");data={type:"user",userid:userid,befgroupid:befgroupid};e.originalEvent.dataTransfer.setData("data",JSON.stringify(data));$("#chat_container .chat_deletebox").show()});$("#chat_container .chat_mesg_item").on("dragend",function(e){$("#chat_container .chat_deletebox").hide()})}_this.openchatevent()}})},searchUG:function(){var _this=this;var searchw=$("#chat_search_input").val().trim();if(searchw){$.ajax({url:_this.config.url+"/search/searchug.action",data:{searchcontent:searchw},success:function(res){if(res.code==200){_this.setSearchContent(res.result,"#chat_search_box .chat_search_rscontent",1)}else{$("#chat_search_box .chat_search_rscontent").html("<center >没有找到任何信息！！！</center>")}}})}else{$("#chat_search_box .chat_search_rscontent").html("<center>请输入有效信息！！！</center>")}},setSearchContent:function(data,insertdiv,addbut){var _this=this;$(insertdiv).empty();var chat_center_box_item=chatpanle.chat_center_box_item;if(data.user&&data.user.length>0){$(insertdiv).append("<center>------匹配到以下用户------</center>");for(var i=0,len=data.user.length;
i<len;i++){var item=data.user[i];var a=$(chat_center_box_item);a.find("img").attr("src",chat.config.sourcepath+"chat/img/default.png");if(item.headimgpath){a.find("img").attr("src",item.headimgpath)}if(addbut==1){a.append('<button class="chat_search_add">添加</button>')}a.attr("user_id",item.uUID);a.find(".chat_name").text(item.username);a.find(".chat_mesg").text(item.description);$(insertdiv).append(a)}}if(data.chatgroup&&data.chatgroup.length>0){$(insertdiv).append("<center>------匹配到以下群聊------</center>");for(var i=0,len=data.chatgroup.length;i<len;i++){var item=data.chatgroup[i];var a=$(chat_center_box_item);a.find("img").attr("src",chat.config.sourcepath+"chat/img/default.png");if(item.headimgpath){a.find("img").attr("src",item.headimgpath)}if(addbut==1){a.append('<button class="chat_search_add">添加</button>')}a.attr("group_id",item.id);a.find(".chat_name").text(item.groupname);a.find(".chat_mesg").text(item.description);$(insertdiv).append(a)}}$("#chat_search_box .chat_mesg_item .chat_search_add").click(function(e){var user_UUID=$(this).parent().attr("user_id");var Group_id=$(this).parent().attr("group_id");if(user_UUID!=undefined){_this.addFriend(user_UUID,$(this),e)}if(Group_id!=undefined){_this.addChatGroup(Group_id,$(this))}})},addMove:function(divbox,movebox){$(movebox).mousedown(function(e){var left=$(divbox).get(0).offsetLeft;var top=$(divbox).get(0).offsetTop;var boxleft=e.clientX-left;var boxtop=e.clientY-top;$(movebox).mousemove(function(e){var left2=e.clientX-boxleft;var top2=e.clientY-boxtop;$(divbox).css({top:top2,left:left2});if(Math.abs(left-left2)>1||Math.abs(top-top2)>1){chat.config.logoevent=false}})});$(movebox).mouseup(function(){$(movebox).unbind("mousemove");chat.config.logoevent=true;if(divbox=="#chatbox"){$(divbox).css({top:0})}})}};var chatpanle={chat_all_box:'<div id="chatbox"> <div id="chat_container"> <div class="chat_add"> <span class="iconfont">&#xe612;</span> </div> <div class="chat_close"> <span class="iconfont">&#xe61c;</span> </div> </div> </div>',chat_head:"<div class='chat_chathead'>  <div class='chat_head1'><div class='chat_headimg'> <img  title='点击更换头像'> <input type='file' class='chat_user_headimg' style='display: none;'/> </div> <div class='chat_mes'> <p class='chat_username'></p> <input class='chat_description' title='' />  </div></div> </div>",chat_center:"<div class='chat_center'></div>",chat_center_nav:"<div class='chat_nav'> <ul> <li class='chat_on'>消息</li> <li>好友</li> <li>群</li> </ul> </div>",chat_center_box:"<div class='chat_center_box'> </div>",chat_center_box_item:"<div class='chat_mesg_item'> <div class='chat_headimg'> <img src=''> </div> <div class='chat_content'> <p class='chat_name'> </p> <p class='chat_mesg'> </p> </div> </div>",friendgroup_item:"<div class='chat_friendgroup_item'> <span class='iconfont'>&#xe60e;</span> <span class='chat_groupname'> </span> </div>",friends:"<div class='chat_friends'> </div>",chat_searchbox:"<div id='chat_search_box'> <span class='iconfont' >&#xe61c;</span> <div class='chat_head'>查 找</div> <div class='chat_search_input'> <input type='text' id='chat_search_input' placeholder='输入用户名或账号,群名或群号'/> <input type='button' id='chat_search_input_but' value='查询' /> </div> <div class='chat_search_rscontent'> </div> </div>",chat_box:'<div id="chat_message_panel"><div class="chat_message_panel_head"><span class="chat_curuser"></span><span class="iconfont" >&#xe61c;</span> </div> <div class="chat_message_panel_body">	</div></div>',chat_box_left:'<div class="chat_users"></div>',chat_box_center:'<div class="chat_message_box"> <div class="chat_message"> <ul></ul> </div> <div class="chat_sendmessage_box"> <textarea class="chat_message_textarea" rows="" cols=""></textarea> <button type="button" class="chat_sendmesg_but">发送</button> <button type="button" class="chat_clearmesg_but">清空</button> </div> </div>',message:'<li><div class="chat_message_item"><p><span class="chat_name"> </span> <span></span></p> <div class="chat_message_item_message"> </div> </div> </li>',chat_box_right:'<div class="chat_chatgroup_member"></div>',choosefriendgroup:'<div class="chat_choosefriendgroup"> <select class="chat_choosefriendgroup_select"> </select> <button class="chat_choosefriendgroup_sure">确定</button> <button class="chat_choosefriendgroup_close">取消</button></div>',creatchatgroup:'<div class="chat_addchatgroup"><input type="text" class="chat_addchatgroup_groupname" placeholder="群名称不超过10个字符"/><input type="text" class="chat_addchatgroup_description" placeholder="群描述不超过30个字符" /><input type="file" class="chat_addchatgroup_headimg" style="display: none;"/> <button class="chat_addchatgroup_headimg_but">+</button> <button type="button" class="chat_addchatgroup_submit">创建</button></div>'};